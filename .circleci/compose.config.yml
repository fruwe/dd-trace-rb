# This configuration was automatically generated from a CircleCI 1.0 config.
# It should include any build commands you had along with commands that CircleCI
# inferred from your project structure. We strongly recommend you read all the
# comments in this file to understand the structure of CircleCI 2.0, as the idiom
# for configuration has changed substantially in 2.0 to allow arbitrary jobs rather
# than the prescribed lifecycle of 1.0. In general, we recommend using this generated
# configuration as a reference rather than using it in production, though in most
# cases it should duplicate the execution of your original 1.0 config.
version: 2
jobs:
  build-2.4.4:
    working_directory: ~/DataDog/dd-trace-rb
    shell: /bin/bash --login
    docker:
    - image: docker:17.05.0-ce-git
    steps:
    - checkout
    - setup_remote_docker
    - run:
        name: Install dependencies
        command: |
          apk add --no-cache \
            py-pip=9.0.0-r1
          pip install \
            docker-compose==1.12.0 \
            awscli==1.11.76
    - restore_cache:
        keys:
          - v1-{{ .Branch }}
        paths:
          - /caches/dd-trace-rb_2.4.4.tar
    - run:
        name: Load Docker image layer cache
        command: |
          set +o pipefail
          docker load -i /caches/dd-trace-rb_2.4.4.tar | true
    - run:
        name: Build dd-trace-rb (2.4.4) Docker image
        command: |
          docker build \
            --cache-from=dd-trace-rb:2.4.4 \
            --build-arg VERSION_SUFFIX=.pre.$CIRCLE_BUILD_NUM
            -t dd-trace-rb:2.4.4 \
            .
    - run:
        name: Save Docker image layer cache
        command: |
          mkdir -p /caches
          docker save -o /caches/dd-trace-rb_2.4.4.tar dd-trace-rb:2.4.4
    - save_cache:
        key: v1-{{ .Branch }}-{{ epoch }}
        paths:
          - /caches/dd-trace-rb_2.4.4.tar
  test-2.4.4:
    working_directory: ~/DataDog/dd-trace-rb
    shell: /bin/bash --login
    environment:
      CIRCLE_TEST_REPORTS: /tmp/circleci-test-results
      CIRCLE_ARTIFACTS: /tmp/circleci-artifacts
    docker:
    - image: docker:17.05.0-ce-git
    steps:
    - checkout
    - setup_remote_docker
    - run:
        name: Install dependencies
        command: |
          apk add --no-cache \
            py-pip=9.0.0-r1
          pip install \
            docker-compose==1.12.0 \
            awscli==1.11.76
    - restore_cache:
        keys:
          - v1-{{ .Branch }}
        paths:
          - /caches/dd-trace-rb_2.4.4.tar
    - run:
        name: Load Docker image layer cache
        command: |
          set +o pipefail
          docker load -i /caches/dd-trace-rb_2.4.4.tar | true
    - run:
        name: Run tests
        command: |
          docker-compose -f ./docker-compose.test.yml up
workflows:
  version: 2
  build_and_test:
    jobs:
      - build-2.4.4
